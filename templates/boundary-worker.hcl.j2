listener "tcp" {
  address = "{{ boundary_address }}:9202"
  purpose = "proxy"
  tls_disable = {{ boundary_tls_disable | lower }}
}

worker {
  name = "{{ ansible_hostname }}-worker"
  description = "Boundary worker."

  # Workers must be able to reach controllers on :9202
  controllers = [
{% for controller in groups['controllers'] %}
    "{{ hostvars[controller]['ansible_default_ipv4']['address'] }}"{% if not loop.last %},{% endif %}{{''}}
{% endfor %}
]
  public_addr = "{{ inventory_hostname }}"
}

% for key_type in ['worker-auth'] %}
{% if boundary_kms_type == 'aead' %}
kms "aead" {
  purpose   = "{{ key_type }}"
  aead_type = "aes-gcm"
  key_id    = "global_{{ key_type }}"
  key       = "{{ boundary_aead_keys[key_type] }}"
}
{% elif boundary_kms_type == 'awskms' %}
kms "awskms" {
  purpose    = "{{ key_type }}"
  region     = "{{ region }}"
  kms_key_id = "{{ boundary_awskms_keys[key_type] }}"
{% if boundary_awskms_endpoint != '' %}
  endpoint   = "{{ boundary_awskms_endpoint }}"
{% endif %}
}
{% elif boundary_kms_type == 'gcpckms' %}
kms "gcpckms" {
  purpose     = "{{ key_type }}"
  credentials = "{{ boundary_gcpckms_credentials }}"
  project     = "{{ boundary_gcpckms_project }}"
  region      = "{{ boundary_gcpckms_region }}"
  key_ring    = "{{ boundary_gcpckms_keyring }}"
  crypto_key  = "{{ boundary_gcpckms_keys[key_type] }}"
}
{% elif boundary_kms_type == 'transit' %}
kms "transit" {
  purpose            = "{{ key_type }}"
  address            = "https://{{ groups.vault_instances[0] }}:8200"
  token              = "{{ lookup('env','VAULT_TOKEN') }}"
  disable_renewal    = "{{ boundary_transit_disable_renewal |default('false') }}"

  // Key configuration
  mount_path         = "{{ boundary_transit_mount_path }}"
  namespace          = "{{ boundary_transit_namespace }}"
  key_name           = "{{ boundary_transit_keys[key_type] }}"

  // TLS Configuration
  tls_server_name    = "{{ boundary_transit_tls_server_name |default(groups.vault_instances[0]) }}"
  tls_ca_cert        = "{{ boundary_transit_tls_ca_file     |default('') }}"
  tls_client_cert    = "{{ boundary_transit_tls_cert_file   |default('') }}"
  tls_client_key     = "{{ boundary_transit_tls_key_file    |default('') }}"
  tls_skip_verify    = "{{ boundary_transit_tls_skip_verify |default('false') }}"
}
{% endif %}
{% endfor %}
